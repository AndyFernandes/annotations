<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Sistema de anotações</title>

    <!-- CSS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
		
	<script src='js/spectrum.js'></script>
	<link rel='stylesheet' href='css/spectrum.css' />

   	<link rel="stylesheet" type="text/css" href="css/styles.css">
   	
   	<!-- JAVASCRIPT -->
    <script type="text/javascript" src="js/script.js"></script>
    
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
		
	<script src='js/spectrum.js'></script>
	<link rel='stylesheet' href='css/spectrum.css' />
		    
		    
	<!-- IMPORTAÇÕES D3ANNOTATIONS & DEMAIS LIBS D3 -->
	<script src="https://d3js.org/d3-geo.v1.min.js"></script>
	<script src="http://d3js.org/d3.v4.min.js" type="text/javascript"></script>
	<script src="js/d3-annotation.min.js"></script>
		    
	<!-- BOOTSTRAP -->
		    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
		    
			<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
			<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>
		    <!-- LEAFLET -->
		    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7/leaflet.css" />
		   	<link href='https://api.tiles.mapbox.com/mapbox.js/v1.6.4/mapbox.css' rel='stylesheet' />
		   	<script src='https://api.tiles.mapbox.com/mapbox.js/v1.6.4/mapbox.js'></script>
		    <script src="http://cdn.leafletjs.com/leaflet-0.7/leaflet.js"></script>
</head>
<body>
    <div class = "row container-fluid no-padding my-1 h-100">
	    <navbar class = "col-sm-4 col-lg-4 no-padding" id="controleMapa">
		        <div id = "create">
		            <div class="botao-camada my-1">
		                <button type="button" data-toggle="collapse" id="botaoCreate" class="btn btn-block btn-outline-main" data-target="#ControleCreate" aria-expanded="false" aria-controls="ControleCreate">Criar anotações</button>
		            </div>
		            <div class="collapse" id="ControleCreate">
		            	<div class="card card-body">
		            		<h5>Cores</h5>
					        <br>
	                        <div id="type" class="section">
	                                <div class="learn-more" id="schemes-learn-more" title="Learn more"></div>
	                                
	                                <p><b>Selecione o tema de cores: </b></p> 

	                                <div class="row" id="scheme">
		                                <div class="colors"> 
		                                	<label for="bg_color">Background color:  </label>
		                                	<input type='text' id="bg_color" />
		                            	</div>
		                                <div class="colors">
		                                	<label for="text_color">Text color:  </label>
		                                	<input type='text' id="text_color" />
		                                </div>
		                            </div>                                         
	                        </div>

	                        <div class="dropdown-divider"></div>
				       		<br>
				            
		                    <button type="button" class="btn btn-outline-dark" id="criar_anotacao" value="Criar anotação">Criar anotação</button>

		                    <div id = "modal_activate" class="bootbox modal fade bootbox-prompt show" tabindex="-1" role="dialog" style="padding-right: 15px; display: block;">
			                    <div class="modal-dialog">
			                     	<div class="modal-content">
			                      		<div class="modal-header">
			                      			<h4 class="modal-title">Por favor, preencha os campos:</h4>
			                   			</div>
			                   			
			                   			<div class="modal-body">
			                   				<div class="bootbox-body">
			                   					<form class="bootbox-form" id="form">
			                   						<label>Título</label>
			                   						<input id="title"  class="bootbox-input bootbox-input-text form-control" autocomplete="off" type="text"  onkeyup="count_caracter(this, 'cont_title_create')">
			                   						<span class="text-muted pull-right" id="cont_title_create">0</span>
			                   						<br><br>
													<label>Contexto</label>
			                      					<textarea id="text" form="form" class="bootbox-input bootbox-input-text form-control" autocomplete="off" type="text" onkeyup="count_caracter(this, 'cont_text_create')"></textarea>
			                      					<span class="text-muted pull-right" id="cont_text_create">0</span>
			                      				</form>

			                      				<div class="dropdown-divider"></div>
				       							<br>

				       							<h4 class="modal-title">Por favor, em seguida selecione o local que deseja criar a anotação.</h4>
			                      			</div>
			                      		</div>
			                      		
			                      		<div class="modal-footer">	
			                      			<button data-bb-handler="cancel" type="button" class="btn btn-default btn_cancel">Cancel</button>
			                      			<button id = "button_OK" data-bb-handler="confirm" type="button" class="btn btn-primary">OK</button>
			                      		</div>
			                      	</div>
			                    </div>
		                    </div>
		            	</div>
		            </div>
				</div>

		        <div id = "update">
		            <div class="botao-camada my-1">
		                <button type="button" data-toggle="collapse" id="botaoUpdate" class="btn btn-block btn-outline-main" data-target="#ControleUpdate" aria-expanded="false" aria-controls="ControleUpdate">Atualizar anotações</button>
		            </div>
		            <div class="collapse" id="ControleUpdate">
		            	<div class="card card-body">
		                    
				                <button id="select_annotation_change" type="button" class="btn btn-outline-dark">Selecione a anotação</button>

			                    <div id = "modal_change" class="bootbox modal fade bootbox-prompt show" tabindex="-1" role="dialog" style="padding-right: 15px; display: block;">
				                    <div class="modal-dialog">
				                     	<div class="modal-content">
				                      		<div class="modal-header">
				                      			<h4 class="modal-title">Por favor, preencha os campos com o que deseja alterar:</h4>
				                   			</div>
				                   			
				                   			<div class="modal-body">
				                   				<div class="bootbox-body">
				                   					<form class="bootbox-form">
				                   						<label>Título</label>
				                   						<input id="title_change"  class="bootbox-input bootbox-input-text form-control" autocomplete="off" type="text" onkeyup="count_caracter(this, 'cont_title_change')">
				                   						<span class="text-muted pull-right" id="cont_title_change">0</span>
				                   						<br><br>
														<label>Contexto</label>
				                      					<textarea id="text_change" class="bootbox-input bootbox-input-text form-control" autocomplete="off" type="text" onkeyup="count_caracter(this, 'cont_text_change')"></textarea>
				                      					<span class="text-muted pull-right" id="cont_text_change">0</span>

				                      					<div class="dropdown-divider"></div>
				       									<br>

				                      					<div id="type" class="section">
							                                <div class="learn-more" id="schemes-learn-more" title="Learn more"></div>
							                                
							                                <label>Selecione as cores</label>

							                                <div class="row" id="scheme">
								                                <div class="colors"> 
								                                	<label for="bg_color">Background color:  </label>
								                                	<input type='text' id="bg_color_change" />
								                            	</div>
								                                <div class="colors">
								                                	<label for="text_color">Text color:  </label>
								                                	<input type='text' id="text_color_change" />
								                                </div>
								                            </div>                                         
							                        </div>
				                      				</form>
				                      			</div>
				                      		</div>
				                      		
				                      		<div class="modal-footer">	
				                      			<button data-bb-handler="cancel" type="button" class="btn btn-default btn_cancel">Cancel</button>
				                      			<button id = "button_OK_change" data-bb-handler="confirm" type="button" class="btn btn-primary">OK</button>
				                      		</div>
				                      	</div>
				                    </div>
			                   
		                    </div>
		            	</div>
		            </div>     
		        </div>
		        
		        <div id = "delete">
		          	<div class="botao-camada my-1">
		                <button type="button" data-toggle="collapse" id="botaoDelete" class="btn btn-block btn-outline-main" data-target="#ControleDelete" aria-expanded="false" aria-controls="ControleDelete">Deletar anotações</button>
		            </div>
		            <div class="collapse" id="ControleDelete">
		            	<div class="card card-body">
		                    
		                        <button id="select_annotation_remove" type="button" class="btn btn-outline-dark" value="Selecionar a anotação">Selecione a anotação</button>
		                        <br>
		                </div>
		            </div> 
		        </div>
	    </navbar>

	    <div class= "col-sm-8 col-lg-8">
	    	<div id="map"> </div>
	   	</div>
	</div>

    <script type="text/javascript">
    	/////////////////////////////// START
    	$('.collapse').collapse();
    	$("#modal_activate").hide();
    	// $("#modal_activate_position").hide();
    	$("#modal_change").hide();

    	$("#bg_color ").spectrum({
			showPalette: true,
			showInitial: true,
			showInput: true,
			preferredFormat: "hex",
			color: 'white',
			palette: [
						["#000",    "#444",    "#666",    "#999",    "#ccc",    "#eee",    "#f3f3f3", "#fff",    "#fff7fb", "#fff7ec"],
						["#f00",    "#f90",    "#ff0",    "#0f0",    "#0ff",    "#00f",    "#90f",    "#f0f",    "#ece7f2", "#fee8c8"],
						["#f4cccc", "#fce5cd", "#fff2cc", "#d9ead3", "#d0e0e3", "#cfe2f3", "#d9d2e9", "#ead1dc", "#d0d1e6", "#fdd49e"],
						["#ea9999", "#f9cb9c", "#ffe599", "#b6d7a8", "#a2c4c9", "#9fc5e8", "#b4a7d6", "#d5a6bd", "#a6bddb", "#fdbb84"],
						["#e06666", "#f6b26b", "#ffd966", "#93c47d", "#76a5af", "#6fa8dc", "#8e7cc3", "#c27ba0", "#74a9cf", "#fc8d59"],
						["#c00",    "#e69138", "#f1c232", "#6aa84f", "#45818e", "#3d85c6", "#674ea7", "#a64d79", "#3690c0", "#ef6548"],
						["#900",    "#b45f06", "#bf9000", "#38761d", "#134f5c", "#0b5394", "#351c75", "#741b47", "#0570b0", "#b30000"],
						["#600",    "#783f04", "#7f6000", "#274e13", "#0c343d", "#073763", "#20124d", "#4c1130", "#045a8d", "#7f0000"]
					]
		});

    	$("#text_color").spectrum({
			showPalette: true,
			showInitial: true,
			showInput: true,
			preferredFormat: "hex",
			color: 'black',
			palette: [
						["#000",    "#444",    "#666",    "#999",    "#ccc",    "#eee",    "#f3f3f3", "#fff",    "#fff7fb", "#fff7ec"],
						["#f00",    "#f90",    "#ff0",    "#0f0",    "#0ff",    "#00f",    "#90f",    "#f0f",    "#ece7f2", "#fee8c8"],
						["#f4cccc", "#fce5cd", "#fff2cc", "#d9ead3", "#d0e0e3", "#cfe2f3", "#d9d2e9", "#ead1dc", "#d0d1e6", "#fdd49e"],
						["#ea9999", "#f9cb9c", "#ffe599", "#b6d7a8", "#a2c4c9", "#9fc5e8", "#b4a7d6", "#d5a6bd", "#a6bddb", "#fdbb84"],
						["#e06666", "#f6b26b", "#ffd966", "#93c47d", "#76a5af", "#6fa8dc", "#8e7cc3", "#c27ba0", "#74a9cf", "#fc8d59"],
						["#c00",    "#e69138", "#f1c232", "#6aa84f", "#45818e", "#3d85c6", "#674ea7", "#a64d79", "#3690c0", "#ef6548"],
						["#900",    "#b45f06", "#bf9000", "#38761d", "#134f5c", "#0b5394", "#351c75", "#741b47", "#0570b0", "#b30000"],
						["#600",    "#783f04", "#7f6000", "#274e13", "#0c343d", "#073763", "#20124d", "#4c1130", "#045a8d", "#7f0000"]
					]
		});

		$("#bg_color_change ").spectrum({
			showPalette: true,
			showInitial: true,
			showInput: true,
			preferredFormat: "hex",
			color: 'white',
			palette: [
						["#000",    "#444",    "#666",    "#999",    "#ccc",    "#eee",    "#f3f3f3", "#fff",    "#fff7fb", "#fff7ec"],
						["#f00",    "#f90",    "#ff0",    "#0f0",    "#0ff",    "#00f",    "#90f",    "#f0f",    "#ece7f2", "#fee8c8"],
						["#f4cccc", "#fce5cd", "#fff2cc", "#d9ead3", "#d0e0e3", "#cfe2f3", "#d9d2e9", "#ead1dc", "#d0d1e6", "#fdd49e"],
						["#ea9999", "#f9cb9c", "#ffe599", "#b6d7a8", "#a2c4c9", "#9fc5e8", "#b4a7d6", "#d5a6bd", "#a6bddb", "#fdbb84"],
						["#e06666", "#f6b26b", "#ffd966", "#93c47d", "#76a5af", "#6fa8dc", "#8e7cc3", "#c27ba0", "#74a9cf", "#fc8d59"],
						["#c00",    "#e69138", "#f1c232", "#6aa84f", "#45818e", "#3d85c6", "#674ea7", "#a64d79", "#3690c0", "#ef6548"],
						["#900",    "#b45f06", "#bf9000", "#38761d", "#134f5c", "#0b5394", "#351c75", "#741b47", "#0570b0", "#b30000"],
						["#600",    "#783f04", "#7f6000", "#274e13", "#0c343d", "#073763", "#20124d", "#4c1130", "#045a8d", "#7f0000"]
					]
		});

    	$("#text_color_change").spectrum({
			showPalette: true,
			showInitial: true,
			showInput: true,
			preferredFormat: "hex",
			color: 'black',
			palette: [
						["#000",    "#444",    "#666",    "#999",    "#ccc",    "#eee",    "#f3f3f3", "#fff",    "#fff7fb", "#fff7ec"],
						["#f00",    "#f90",    "#ff0",    "#0f0",    "#0ff",    "#00f",    "#90f",    "#f0f",    "#ece7f2", "#fee8c8"],
						["#f4cccc", "#fce5cd", "#fff2cc", "#d9ead3", "#d0e0e3", "#cfe2f3", "#d9d2e9", "#ead1dc", "#d0d1e6", "#fdd49e"],
						["#ea9999", "#f9cb9c", "#ffe599", "#b6d7a8", "#a2c4c9", "#9fc5e8", "#b4a7d6", "#d5a6bd", "#a6bddb", "#fdbb84"],
						["#e06666", "#f6b26b", "#ffd966", "#93c47d", "#76a5af", "#6fa8dc", "#8e7cc3", "#c27ba0", "#74a9cf", "#fc8d59"],
						["#c00",    "#e69138", "#f1c232", "#6aa84f", "#45818e", "#3d85c6", "#674ea7", "#a64d79", "#3690c0", "#ef6548"],
						["#900",    "#b45f06", "#bf9000", "#38761d", "#134f5c", "#0b5394", "#351c75", "#741b47", "#0570b0", "#b30000"],
						["#600",    "#783f04", "#7f6000", "#274e13", "#0c343d", "#073763", "#20124d", "#4c1130", "#045a8d", "#7f0000"]
					]
		});

    	///////////////////////////// START MAP AND SVG
        // Vetor de anotações
		var annotations = [];
		var contador = 0;


        var mapboxTiles = 	L.tileLayer('https://{s}.tiles.mapbox.com/v3/examples.map-zr0njcqy/{z}/{x}/{y}.png', {
    	        						attribution: '<a href="http://www.mapbox.com/about/maps/" target="_blank">Terms &amp; Feedback</a>'
    	    				});
        // Criação do mapa
  	    var map = L.map('map')
  	             .addLayer(mapboxTiles)
  	             .setView([-3.786493992586659, -38.56006443500519], 12);

        mapLink = '<a href="http://openstreetmap.org">OpenStreetMap</a>';
        
        L.tileLayer(
            'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; ' + mapLink + ' Contributors',
                maxZoom: 18,
                }).addTo(map);
          
        // Quando o mapa mover ou dar zoom as anotações serão reposicionadas no seu local de origem de criação
        map.on("zoom", change);
        map.on("move", change);

        function change(e){
            annotations.forEach((d,i) => {
                var annotation = d.annotations()[0]
                
                // coordenadas
                let newCoord = map.latLngToContainerPoint(annotation.data.data)
                annotation._x = newCoord.x - margin.left
                annotation._y = newCoord.y - margin.top

                // cores
                var id = annotation.data.id;
                console.log(id);

                var text_color = annotation.data.colors.text;

                console.log(text_color);
                // console.log($("#"+id).find("path")[2].attr("stroke", text_color));
                $("#"+id).find("path").css("stroke", text_color);
                $("#"+id).find("path").attr("stroke", text_color);
                // .css("stroke", text_color); // haste
                d.update()
            })
        };

        // Criação dos elementos gráficos para anotações
        const h = document.getElementById('map').offsetHeight;
        const w = document.getElementById('map').offsetWidth;
        const margin = {left: 20, right: 20, top: 40, bottom: 20};
        const innerW = w - (margin.left + margin.right);
        const innerH = h - (margin.top + margin.bottom);

        var svg = d3.select("#map").append("svg")
  	                .attr("width", w)
  	                .attr("height", h);

        var g = svg.append("g").attr("class", "leaflet-zoom-hide");

        
        ///////////////////////////////////////////////////////// FUNCTIONS JS
	    $(".btn_cancel").click(function(){
	    	$(".modal").hide();
	    })

	    function count_up(element) { 	  
	    	obj = document.all(field); 	  
	    	if (MaxLength !=0) { 		 
	    		if (obj.value.length > MaxLength)  {			
	    			obj.value = obj.value.substring(0, MaxLength); 			
	    		}	  
	    	} 	  
	    	// console.log(obj);
	    	$("#contador").val() = obj.value.length + '/300';   
	    }

	    function count_caracter(element, id){
	    	document.getElementById(id).innerHTML = element.value.length;

	    	// document.getElementById(id).innerHTML = 250 - element.value.length;

	    	// if (250 - element.value.length < 0){
	    	// 	document.getElementById(id).style.color = "red";
	    	// } else {
	    	// 	document.getElementById(id).style.color = "grey";
	    	// }

	    }

	    
	    ////////////////////// CREATE
        $("#criar_anotacao").click(function(){
            $("#modal_activate").show();
            
            var annotation_title;
            var annotation_text;
            var text_color = $("#text_color").val();
			var bg_color = $("#bg_color").val();
			var path_color = $("#text_color").val();

			document.getElementById("cont_title_create").innerHTML = "0";
    		document.getElementById("cont_text_create").innerHTML = "0";
           	
           	// Variável utilizada para não deixar criar várias anotações de uma vez - Controle de cliques - só pode clicar uma vez
            var canClick = true
            $("#button_OK").click(function(){
            	if (canClick){
	            	annotation_title = $("#title").val();
	            	annotation_text = $("#text").val();

	            	if(annotation_text == ""){
	            		annotation_text = " ";
	            	}

	            	if(annotation_title == ""){
	            		annotation_title = " ";
	            	}

					$("#modal_activate").hide();
					map.on('click', onMapClick);
			        
					function onMapClick(e) {
					    if(canClick){
					        canClick = false;
					     	create_annotation([e.containerPoint.x,e.containerPoint.y], e.latlng, annotation_title, annotation_text, text_color, bg_color, path_color);
						}
				    };
				}
	    	});
        });


        function create_annotation(coordenadas, data, annotation_title, annotation_text, text_color, bg_color, path_color){
    		    // Criação do Json com as propriedades da anotação inputadas pelo user
    			const this_annotation = [{
							    	        note: {
							    	            label: annotation_text,
							    	            title: annotation_title,
							    	            lineType: "vertical",
							    	            padding: 25,
							    	            wrap: 600,
							    	            bgPadding: {top: 25, left: 15, right: 10, bottom: 5}

							    	        },
							    	        connector: {
							    	            end: "arrow"
							    	        },
							                x: coordenadas[0] - margin.left,
							                y: coordenadas[1] - margin.top,
							    	        dx: 40,
							    	        dy: -40,
							                // data: data,
							                data: {'data': data, 'id': contador, 'colors':{'text': text_color, 'bg': bg_color}},
							                className: "show-bg"
					    	    		}];
					    	   

				const makeThis = d3.annotation()
									.type(d3.annotationLabel)
								    .annotations(this_annotation)
								    .editMode(true);

				// Adição da nova anotação no vetor de anotações
				annotations.push(makeThis); 
				
				// Agregando a anotação aos elementos gráficos 
				var gg = g.append("g")
							.attr("class", "leaflet-zoom-hide")
					        .attr("id", `${contador}`)
						    .attr("transform","translate("+margin.left+","+margin.top+")")
						    .attr("class","annotation-group")
						    .call(makeThis)

				
				// ajustes de margen + arredondamento do rect(background)
				$("#"+contador).find(".annotation-note").find("circle").attr("class", "handle-2"); //background
				$("#"+contador).find("rect").attr("rx", "10"); //background
				$("#"+contador).find("rect").attr("ry", "10"); //background
				$("#"+contador).find("tspan").attr("x", "15"); // margin-left tspan - elementos do text


				// Modificações das cores
				$("#"+contador).find("rect").css("fill", bg_color); //background
				$("#"+contador).find("rect").css("fill-opacity", 0.7); //background
				$("#"+contador).find("tspan").css("fill", text_color); // texto
				$("#"+contador).find("path").attr("style", "stroke: " + path_color + "; fill: none"); // haste
				$("#"+contador).find(".handle-2").css("stroke", path_color); // bolinha

				
				// ajuste tamanhos 
				var width = +$("#"+contador).find("rect").width();
				var height = +$("#"+contador).find("rect").height();

				$("#"+contador).find("rect").attr("width", 50+width);
				$("#"+contador).find("rect").attr("height", height+30);

				contador = contador + 1;

				$("#text").val('');
				$("#title").val('');
    	}

    	// Modificação das propriedades de uma anotação - Refere-se a aba de alterar anotação no menu
    	function change_annotation(id){
    		// inputando textos da anotação selecionada nos input text do modal de mudança do conteúdo da anotaçãoa
    		var title = $("#"+id).find(".annotation-note-title").find("tspan")[0]["innerHTML"];
    		var text = $("#"+id).find(".annotation-note-title").find("tspan")[0]["innerHTML"];

    		$("#title_change").val(title);
    		$("#text_change").val(text);

    		// $("#bg_color_change").val(
    		// 	$("#"+id).find(rect).attr()
    		// 	);
    		// $("#text_color_change").val(text);

    		document.getElementById("cont_title_change").innerHTML = title.length;
    		document.getElementById("cont_text_change").innerHTML = text.length;

    		$("#modal_change").show();

    		$("#button_OK_change").click(function(){
    			$("#modal_change").hide();

				var an = annotations[id].annotations()[0];

				an.note.title =  $("#title_change").val();
				an.note.label = $("#text_change").val();

				annotations[id].updateText();

				// ajuste tamanhos 
				var width = +$("#"+id).find("rect").width();
				var height = +$("#"+id).find("rect").height();

				$("#"+id).find("rect").attr("width", 50+width);
				$("#"+id).find("rect").attr("height", height+30);
				$("#"+id).find("tspan").attr("x", "15");
    		});
	    }

    	$("#select_annotation_change").click(function(){
    		$(".annotation-group").off("click");
    		$(".annotation-group").on("click", function(){
	    		change_annotation($(this)[0].id);
	    	});
	    });

    	
	    $("#select_annotation_remove").on("click", function(event2){
			$(".annotation-group").off("click");
			$(".annotation-group").on("click", function(event){
		    	$("#"+ $(this)[0].id).hide();
	    	});
	    	
	    });
    </script>
</body>
</html>